name: Deploy to EC2 (build & run Docker)

on:
  push:
    branches:
      - master   # trigger on push to main branch

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
      # Checkout repository
      - name: Checkout repository
        uses: actions/checkout@v4

      # Set up SSH key from secret
      # SSH key is used to authenticate the connection to EC2 instance
      - name: Set up SSH key
        env:
          SSH_KEY: ${{ secrets.EC2_SSH_KEY }} # SSH key for EC2 instance
        run: |
          echo "$SSH_KEY" > key.pem
          chmod 400 key.pem

      # Copy repository files to EC2
      # SSH key is used to authenticate the connection to EC2 instance
      - name: Copy files to EC2
        run: |
          scp -o StrictHostKeyChecking=no -i key.pem -r ./ ${{ secrets.EC2_USER }}@${{ secrets.EC2_HOST }}:/home/${{ secrets.EC2_USER }}/ml_app

      # SSH to EC2, install Docker, build and run container
      # SSH key is used to authenticate the connection to EC2 instance
      - name: SSH to EC2 and deploy Docker
        run: |
          ssh -o StrictHostKeyChecking=no -i key.pem ${{ secrets.EC2_USER }}@${{ secrets.EC2_HOST }} << 'EOF'
            set -e
            cd /home/ec2-user/ml_app || exit 0

            # Install Docker if not already installed
            sudo yum update -y
            sudo amazon-linux-extras install docker -y
            sudo service docker start

            # Stop & remove old container if exists
            sudo docker rm -f linear-reg-api || true

            # Build Docker image
            sudo docker build -t linear-reg-api .

            # Run Docker container
            sudo docker run -d -p 8000:8000 --name linear-reg-api linear-reg-api

            # List running containers
            sudo docker ps
          EOF 
